#!/bin/bash

# Enhanced screenshot script with auto-organization and fast OCR indexing

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${OMARCHY_SCREENSHOT_DIR:-${XDG_PICTURES_DIR:-$HOME/Pictures}}"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  notify-send "Screenshot directory does not exist: $OUTPUT_DIR" -u critical -t 3000
  exit 1
fi

# Take the screenshot first (same as original)
pkill slurp || hyprshot -m ${1:-region} --raw |
  satty --filename - \
    --output-filename "$OUTPUT_DIR/screenshot-$(date +'%Y-%m-%d_%H-%M-%S').png" \
    --early-exit \
    --actions-on-enter save-to-clipboard \
    --save-after-copy \
    --copy-command 'wl-copy'

# Post-screenshot processing (run in background to avoid slowing down screenshot)
{
    # Wait a moment for the file to be fully written
    sleep 0.5
    
    # Auto-organize new screenshots
    if [[ -f "/home/sspaeti/.config/hypr/sspaeti/image-browser/auto-organize-screenshot.sh" ]]; then
        "/home/sspaeti/.config/hypr/sspaeti/image-browser/auto-organize-screenshot.sh" >/dev/null 2>&1
    fi
    
    # Fast OCR indexing - only recent screenshots
    if [[ -f "/home/sspaeti/.config/hypr/sspaeti/image-browser/screenshot-indexer-parallel.sh" ]]; then
        "/home/sspaeti/.config/hypr/sspaeti/image-browser/screenshot-indexer-parallel.sh" --recent >/dev/null 2>&1
    fi
    
    # Optional: Show notification when processing is complete
    # notify-send "Screenshot processed and indexed" -t 1000
    
} &  # Run all post-processing in background
