#!/bin/bash

# Custom system menu with tmux-aware shutdown/restart
# Replaces omarchy-menu system functionality with proper tmux handling
# FIXED 1-2 minutes shutdown as an tangling Neovim session is not closing as file is unsaved
# Updated to support dynamic suspend and hibernate options based on system capabilities

export PATH="$HOME/.local/share/omarchy/bin:$PATH"

menu() {
  local prompt="$1"
  local options="$2"
  local extra="$3"

  read -r -a args <<<"$extra"
  echo -e "$options" | walker --dmenu --theme dmenu_250 -p "$prompt…" "${args[@]}"
}

handle_tmux_and_poweroff() {
  # Use the intercept script for tmux-aware shutdown
  ~/.config/hypr/sspaeti/omarchy-system-menu-intercept poweroff
}

handle_tmux_and_reboot() {
  # Use the intercept script for tmux-aware reboot
  ~/.config/hypr/sspaeti/omarchy-system-menu-intercept reboot
}

# Build menu options dynamically based on system capabilities
options="  Lock\n󱄄  Screensaver"
[ -f ~/.local/state/omarchy/toggles/suspend-on ] && options="$options\n󰒲  Suspend"
omarchy-hibernation-available && options="$options\n󰤁  Hibernate"
options="$options\n󰜉  Restart\n󰐥  Shutdown"

case $(menu "System" "$options") in
  *Lock*) omarchy-lock-screen ;;
  *Screensaver*) omarchy-launch-screensaver force ;;
  *Suspend*) systemctl suspend ;;
  *Hibernate*) systemctl hibernate ;;
  *Restart*) handle_tmux_and_reboot ;;
  *Shutdown*) handle_tmux_and_poweroff ;;
esac
