#!/bin/bash

# Intercept script for omarchy-menu to add tmux-aware shutdown/restart
# This script wraps systemctl calls to use our custom system menu
# Updated to use omarchy-state like the official omarchy-menu

export PATH="$HOME/.local/share/omarchy/bin:$PATH"

if [[ "$1" == "poweroff" ]]; then
    # Log to both journal and persistent file
    logger -t "omarchy-shutdown" "Shutdown script called - poweroff"
    echo "$(date): Shutdown script called - poweroff" >> /var/log/omarchy-shutdown.log
    # Save tmux sessions and close gracefully before shutdown
    if command -v tmux &> /dev/null && tmux list-sessions &> /dev/null; then
        logger -t "omarchy-shutdown" "Found tmux sessions, saving and killing"
        echo "$(date): Found tmux sessions, saving and killing" >> /var/log/omarchy-shutdown.log
        # Save all tmux sessions using resurrect
        tmux run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh'
        sleep 2
        # Kill all tmux sessions gracefully with more aggressive timeout
        timeout 2s tmux kill-server || logger -t "omarchy-shutdown" "tmux kill-server timed out, forcing kill"
        logger -t "omarchy-shutdown" "tmux kill-server completed"
        echo "$(date): tmux kill-server completed" >> /var/log/omarchy-shutdown.log
    fi
    # Use omarchy-state to clear restart-required notifications before shutdown
    omarchy-state clear re*-required
    exec /usr/bin/systemctl poweroff --no-wall
elif [[ "$1" == "reboot" ]]; then
    # Log to both journal and persistent file
    logger -t "omarchy-shutdown" "Shutdown script called - reboot"
    echo "$(date): Shutdown script called - reboot" >> /var/log/omarchy-shutdown.log
    # Save tmux sessions and close gracefully before restart
    if command -v tmux &> /dev/null && tmux list-sessions &> /dev/null; then
        logger -t "omarchy-shutdown" "Found tmux sessions, saving and killing"
        echo "$(date): Found tmux sessions, saving and killing" >> /var/log/omarchy-shutdown.log
        # Save all tmux sessions using resurrect
        tmux run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh'
        sleep 2
        # Kill all tmux sessions gracefully with more aggressive timeout
        timeout 2s tmux kill-server || logger -t "omarchy-shutdown" "tmux kill-server timed out, forcing kill"
        logger -t "omarchy-shutdown" "tmux kill-server completed"
        echo "$(date): tmux kill-server completed" >> /var/log/omarchy-shutdown.log
    fi
    # Use omarchy-state to clear restart-required notifications before reboot
    omarchy-state clear re*-required
    exec /usr/bin/systemctl reboot --no-wall
else
    # For all other systemctl commands, pass through normally
    exec /usr/bin/systemctl "$@"
fi
