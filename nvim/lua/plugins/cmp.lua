
local check_backspace = function()
  local col = vim.fn.col "." - 1
  return col == 0 or vim.fn.getline("."):sub(col, col):match "%s"
end

-- Ôóè Ôö® Ô≠Ñ ÔØü Ôëè Ôô± some other good icons
local kind_icons = {
  Text = "Ôùæ",
  Method = "m",
  Function = "Ôûî",
  Constructor = "Ôê•",
  Field = "Óúñ",
  Variable = "Ôö¶",
  Class = "Ô†ñ",
  Interface = "ÔÉ®",
  Module = "Ôíá",
  Property = "ÔÇ≠",
  Unit = "Óàü",
  Value = "Ô¢ü",
  Enum = "ÔÖù",
  Keyword = "Ô†ä",
  Snippet = "ÔÉÑ",
  Color = "Ô£ó",
  File = "Ôúò",
  Reference = "ÔíÅ",
  Folder = "Ôùä",
  EnumMember = "ÔÖù",
  Constant = "Ôõº",
  Struct = "ÔÜ≥",
  Event = "ÔÉß",
  Operator = "Ôöî",
  TypeParameter = "ÔûÉ",
}

--updated from when setting up rust from :
-- Completion Plugin Setup
local cmp = require'cmp'
cmp.setup({
  -- Enable LSP snippets
  snippet = {
    expand = function(args)
        vim.fn["vsnip#anonymous"](args.body)
    end,
  },
  mapping = {
    ["<C-k>"] = cmp.mapping.select_prev_item(),
		["<C-j>"] = cmp.mapping.select_next_item(),
    ["<C-n>"] = cmp.mapping.select_prev_item(),
		["<C-p>"] = cmp.mapping.select_next_item(),
    ["<C-d>"] = cmp.mapping.scroll_docs(-4),
    ["<C-u>"] = cmp.mapping.scroll_docs(4),
    ["<C-Space>"] = cmp.mapping.complete(),
    ["<C-y>"] = cmp.config.disable, -- Specify `cmp.config.disable` if you want to remove the default `<C-y>` mapping.
    ['<C-e>'] = cmp.mapping.close(),
    -- Accept currently selected item. If none selected, `select` first item.
    -- Set `select` to `false` to only confirm explicitly selected items.
    ['<CR>'] = cmp.mapping.confirm({
      behavior = cmp.ConfirmBehavior.Replace,
      select = true
    }),
    --works well with copilot and cmp https://www.reddit.com/r/neovim/comments/sk70rk/comment/hxephoi/?utm_source=share&utm_medium=web2x&context=3
    -- ['<Tab>'] = cmp.mapping(function(fallback)
    --   local copilot_keys = vim.fn['copilot#Accept']()
    --   if cmp.visible() then
    --     cmp.select_next_item()
    --   -- elseif luasnip.expand_or_jumpable() then
    --   --   luasnip.expand_or_jump()
    --   elseif copilot_keys ~= '' and type(copilot_keys) == 'string' then
    --     vim.api.nvim_feedkeys(copilot_keys, 'i', true)
    --   elseif check_backspace() then
    --     fallback()
    --   else
    --     fallback()
    --   end
    -- end, {
    --   'i',
    --   's',
    -- }),
    -- ["<S-Tab>"] = cmp.mapping(function(fallback)
    --   if cmp.visible() then
    --     cmp.select_prev_item()
    --   elseif luasnip.jumpable(-1) then
    --     luasnip.jump(-1)
    --   else
    --     fallback()
    --   end
    -- end, {
    --   "i",
    --   "s",
    -- }),
  },
})

--- inital config:
cmp.setup {
  snippet = {
    expand = function(args)
      luasnip.lsp_expand(args.body) -- For `luasnip` users.
    end,
  },
  formatting = {
    fields = { "kind", "abbr", "menu" },
    format = function(entry, vim_item)
      -- Kind icons
      -- vim_item.kind = string.format("%s", kind_icons[vim_item.kind])
      vim_item.kind = string.format('%s %s', kind_icons[vim_item.kind], vim_item.kind) -- This concatonates the icons with the name of the item kind
      vim_item.menu = ({
        nvim_lsp = "[LSP]",
        luasnip = "[Snippet]",
        buffer = "[Buffer]",
        path = "[Path]",
      })[entry.source.name]
      return vim_item
    end,
  },
  --alternative
  -- formatting = {
  --     format = function(entry, item)
  --         local menu_icon ={
  --             nvim_lsp = 'Œª',
  --             vsnip = '‚ãó',
  --             buffer = 'Œ©',
  --             path = 'üñ´',
  --         }
  --         item.menu = menu_icon[entry.source.name]
  --         return item
  --     end,
  -- },
  sources = {
    { name = 'path' },                              -- file paths
    { name = 'nvim_lsp', keyword_length = 3 },      -- from language server
    { name = 'nvim_lsp_signature_help'},            -- display function signatures with current parameter emphasized
    { name = 'nvim_lua', keyword_length = 2},       -- complete neovim's Lua runtime API such vim.lsp.*
    { name = 'buffer', keyword_length = 2 },        -- source current buffer
    { name = 'vsnip', keyword_length = 2 },         -- nvim-cmp source for vim-vsnip 
    { name = 'calc'},                               -- source for math calculation
  },
  confirm_opts = {
    behavior = cmp.ConfirmBehavior.Replace,
    select = true,
  },
  window = {
    documentation = {
      border = { "‚ï≠", "‚îÄ", "‚ïÆ", "‚îÇ", "‚ïØ", "‚îÄ", "‚ï∞", "‚îÇ" },
    },
    -- documentation = cmp.config.window.bordered(),
    completion = cmp.config.window.bordered(),
  },
  experimental = {
    ghost_text = false,
    native_menu = false,
  },
}
